//
//  MapConfig.m
//  Miner
//
//  Created by zhihua.qian on 14-11-11.
//  Copyright (c) 2014年 jim kaden. All rights reserved.
//

#import "MapConfig.h"

@implementation MapBase

@end

@implementation MapDef

@end


@implementation MapConfig

static MapConfig * _mapConfig = nil;

+(MapConfig *)share
{
    if (_mapConfig == nil)
    {
        _mapConfig = [[MapConfig alloc]init];
    }
    return _mapConfig;
}

-(void)dealloc
{
    Definitions = nil;
}

-(void)reset
{
    [super reset];
    Definitions = nil;
}

//
// 重载了父类的方法
//
-(void)initWithString:(NSString *)buffer
{
    NSMutableArray *rows = (NSMutableArray *)[buffer componentsSeparatedByString:@"\r\n"];
    for (int k=1; k<[rows count]-1; k++)
    {
        NSMutableArray *cols = (NSMutableArray *)[[rows objectAtIndex:k] componentsSeparatedByString:@"\t"];
        MapDef *def = [[MapDef alloc]init];
        
        int i=0;
        def.mapID = [[cols objectAtIndex:i++] integerValue];
        def.mapName     = [cols objectAtIndex:i++];
        def.mapDes      = [cols objectAtIndex:i++];
        def.mapIcon     = [cols objectAtIndex:i++];
        def.normalTime  = [[cols objectAtIndex:i++] integerValue];
        def.ppl_exp     = [[cols objectAtIndex:i++] integerValue];
        def.pet_exp     = [[cols objectAtIndex:i++] integerValue];
        def.boss_pplexp = [[cols objectAtIndex:i++] integerValue];
        def.boss_petexp = [[cols objectAtIndex:i++] integerValue];
        def.basicWin    = [[cols objectAtIndex:i++] integerValue];
        def.bottomWin   = [[cols objectAtIndex:i++] integerValue];
        def.minLv       = [[cols objectAtIndex:i++] integerValue];
        def.maxLv       = [[cols objectAtIndex:i++] integerValue];
        def.mobNum      = [[cols objectAtIndex:i++] integerValue];
        def.battleTcID  = [[cols objectAtIndex:i++] integerValue];
        def.bossID      = [[cols objectAtIndex:i++] integerValue];
        def.bossTcID    = [[cols objectAtIndex:i++] integerValue];
        NSMutableDictionary *tempDic = [[NSMutableDictionary alloc]init];
        while (i<[cols count]-1)
        {
            MapBase *mb = [[MapBase alloc]init];
            mb.ranid      = [[cols objectAtIndex:i++] integerValue];
            mb.ranidRatio = [[cols objectAtIndex:i++] integerValue];
            [tempDic setObject:mb forKey:[NSString stringWithFormat:@"%lu", mb.ranid]];
        }
        def.eventDatas  = [[NSDictionary alloc]initWithDictionary:tempDic];
        def.petID       = [[cols objectAtIndex:i++] integerValue];
        
        [self addRow:def];
    }
}

//
// 重载了父类的方法
//
-(void)loadDBFromLocal
{
    Definitions = [[NSMutableDictionary alloc]init];
    for (int i=0; i<[self numOfRow]; i++)
    {
        MapDef *def = [self rowAtIndex:i];
        [Definitions setObject:def forKey:[NSString stringWithFormat:@"%lu", def.mapID]];
        def =nil;
    }
}

//
// 返回所有的map def
//
-(NSArray*)getAllMapdef
{
    return _DB;
}
//
// 根据mapid 来获取对应的map def
//
-(MapDef*)getMapDefWithID:(NSNumber*)identifier
{
    MapDef *def = [Definitions objectForKey:[identifier stringValue]];
    return def;
}
@end

//
//  StoreCollectionViewCell.m
//  Miner
//
//  Created by biggoldenbee on 15/1/19.
//  Copyright (c) 2015年 jim kaden. All rights reserved.
//

#import "StoreCollectionViewCell.h"

#import "GameUtility.h"
#import "PackageManager.h"

#import "GameObject.h"
#import "StringConfig.h"
#import "EquipmentConfig.h"
#import "ItemConfig.h"

@implementation Goods
/*
 Cnt = 2;
 DCnt = 10000;
 Luck = 2000;
 MCnt = 50;
 MType = 2;
 Sold = 0;
 Token = 2qc;
 Type = 358;
 
 */
-(void)setDataWithDictionary:(NSDictionary *)data{
    self.Cnt    = [[data objectForKey:@"Cnt"] integerValue];
    self.DCnt   = [[data objectForKey:@"DCnt"] integerValue];
    self.Luck   = [[data objectForKey:@"Luck"] integerValue];
    self.MCnt   = [[data objectForKey:@"MCnt"] integerValue];
    self.MType  = [[data objectForKey:@"MType"] integerValue];
    self.Sold   = [[data objectForKey:@"Sold"] integerValue];
    self.Token  = [data objectForKey:@"Token"];
    self.Type   = [[data objectForKey:@"Type"] integerValue];
}
@end

@interface StoreCollectionViewCell()
@property (nonatomic, assign) NSInteger theStoreType;
@property (nonatomic, assign) Goods *theGoods;
@end

@implementation StoreCollectionViewCell

-(id)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self)
    {
        NSArray *arrayOfView = [[NSBundle mainBundle] loadNibNamed:@"StoreCollectionViewCell" owner:self options:nil];
        
        if (arrayOfView.count < 1)
        {
            return nil;
        }
        
        if (![[arrayOfView objectAtIndex:0] isKindOfClass:[StoreCollectionViewCell class]])
        {
            return nil;
        }
        
        self = [arrayOfView objectAtIndex:0];

        // 设置buy button相关的属性和底图
        [self.itemBuy setTitle:@"Buy" forState:UIControlStateNormal];
        [self.itemBuy setTitle:@"Sold Out" forState:UIControlStateDisabled];
        [self.itemBuy setBackgroundImage:[GameUtility imageNamed:@"base_button11_a.png"] forState:UIControlStateNormal];
        [self.itemBuy setBackgroundImage:[GameUtility imageNamed:@"base_button11_b.png"] forState:UIControlStateHighlighted];
        [self.itemBuy setBackgroundImage:[GameUtility imageNamed:@"base_button11_c.png"] forState:UIControlStateDisabled];

    }
    return self;
}

- (void)awakeFromNib {
    // Initialization code
}

-(void)setDataWithObject:(Goods *)inGoods storeType:(NSInteger)storeType{
    self.theGoods = inGoods;
    self.theStoreType =storeType;
    
    // 载入icon
    if (self.theGoods.Type<60000){ // 默认小于60000时物品
        ItemDef* itemDef = [[ItemConfig share] getItemDefWithKey:[NSNumber numberWithInteger:self.theGoods.Type]];
        
        [self.itemPropsBar setImage:[GameUtility imageNamed:@"base_propsbar_b.png"]];
        [self.itemIcon setImage:[GameUtility imageNamed:[itemDef itemIcon]]];
        [self.itemPropsName setText:[[StringConfig share] getLocalLanguage:itemDef.itemName]];
        [self.itemPrice setText:[NSString stringWithFormat:@"%ld-%ld", (long)inGoods.MCnt,(long)inGoods.Cnt]];
        [self.itemCurrency setImage:[GameUtility imageNamed:[NSString stringWithFormat:@"base_icon_1%1d",(int)self.theGoods.MType]]];
        if (0==inGoods.Sold){
            [self.itemBuy setEnabled:TRUE];
        } else if (1==inGoods.Sold){
            [self.itemBuy setEnabled:FALSE];
        } else {
            [self.itemBuy setTitle:@"Error" forState:UIControlStateDisabled];
            [self.itemBuy setEnabled:FALSE];
        }
    } else if (self.theGoods.Type>60000){ // 默认大于60000是装备
        EquipmentDef* equipDef = [[EquipmentConfig share] getEquipmentDefWithKey:[NSNumber numberWithInteger:self.theGoods.Type]];

        [self.itemPropsBar setImage:[GameUtility imageNamed:[GameUtility getImageNameForBagOrSelectViewWithStar:(int)[equipDef equipStar]]]];
        [self.itemIcon setImage:[GameUtility imageNamed:[equipDef equipIcon]]];
        [self.itemPropsName setText:[[StringConfig share] getLocalLanguage:equipDef.equipName]];
        [self.itemPrice setText:[NSString stringWithFormat:@"%ld", (long)inGoods.MCnt]];
        [self.itemCurrency setImage:[GameUtility imageNamed:[NSString stringWithFormat:@"base_icon_1%1d",(int)self.theGoods.MType]]];
        if (0==inGoods.Sold){
            [self.itemBuy setEnabled:TRUE];
        } else if (1==inGoods.Sold){
            [self.itemBuy setEnabled:FALSE];
        } else {
            [self.itemBuy setTitle:@"Error" forState:UIControlStateDisabled];
            [self.itemBuy setEnabled:FALSE];
        }
    }
//    [self.itemBuy setTitle:[[StringConfig share] getLocalLanguage:@"Buy"] forState:UIControlStateNormal];
}

-(void)storeBuyGoods{
    NSMutableDictionary* tempDict = [[NSMutableDictionary alloc]init];
    [tempDict setObject:[NSNumber numberWithInt:(int)[self theStoreType]] forKey:@"Type"];
    [tempDict setObject:self.theGoods.Token forKey:@"Token"];
    [[PackageManager sharedInstance] storeBuyGoods:tempDict];
}

- (IBAction)onItemBuyClick:(id)sender {
    [self storeBuyGoods];
    // 测试button是否能disable
//    [self.itemBuy setEnabled:FALSE];
    NSLog(@"StoreCollectionViewCell:onItemBuyClick\n");
}

@end

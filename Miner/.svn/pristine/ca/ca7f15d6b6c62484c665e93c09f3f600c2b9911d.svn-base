//
//  UpSubAttriViewController.m
//  Miner
//
//  Created by zhihua.qian on 14-12-1.
//  Copyright (c) 2014年 jim kaden. All rights reserved.
//

#import "UpSubAttriViewController.h"
#import "GameObject.h"
#import "GameUtility.h"
#import "PackageManager.h"
#import "QQEquipBtnSelected.h"
#import "Equipment.h"
#import "Item.h"
#import "GameUI.h"

@implementation CostItem

@end

@interface UpSubAttriViewController ()

@property (nonatomic, assign) BOOL isOkToUp;
@property (nonatomic, strong) NSMutableArray* itemsWillCost;

@end

@implementation UpSubAttriViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
    self.isOkToUp = false;
    [self setupAllItemViews];
    
    [self hidenAllAttriLabel];
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

//
-(void)setupAllItemViews
{
    self.itemViewArray = [[NSArray alloc] initWithObjects:self.item1View,self.item2View,self.item3View,self.item4View,nil];
    // 每个view只有个subview
    for (int i=0; i<[self.itemViewArray count]; i++)
    {
        NSArray* nibs = [[NSBundle mainBundle] loadNibNamed:@"QQEquipBtnView" owner:self options:nil];
        QQEquipBtnSelected* selectedState = [nibs objectAtIndex:1];
        UIView* tempView = [self.itemViewArray objectAtIndex:i];
        [selectedState setStateType:i+10];
        selectedState.frame = tempView.bounds;
        [tempView addSubview:selectedState];
        [selectedState setHidden:YES];
    }
}
-(void)resetAllItemView
{
    for (int i=0; i<[self.itemViewArray count]; i++)
    {
        UIView* tempView = [self.itemViewArray objectAtIndex:i];
        QQEquipBtnSelected* selectedState = [[tempView subviews] objectAtIndex:0];
        [selectedState setStateType:i+10];
        [selectedState setHidden:YES];
    }
}

-(void)hidenAllAttriLabel
{
    [self.item1View setHidden:NO];
    [self.item2View setHidden:NO];
    [self.item3View setHidden:NO];
    [self.item4View setHidden:NO];
    
    [self setHiddenSubAttribute1Controllers:YES];
    [self setHiddenSubAttribute2Controllers:YES];
    [self setHiddenSubAttribute3Controllers:YES];
}

-(void)setHiddenSubAttribute1Controllers:(BOOL)hidden
{
    self.subAttri1Identifier = nil;
    [self.subAttri1IconImage setHidden:hidden];
    [self.subAttri1ValueLabel setHidden:hidden];
    [self.subAttri1ArrowImage setHidden:hidden];
    [self.subNextAttri1ValueLabel setHidden:hidden];
}

-(void)setHiddenSubAttribute2Controllers:(BOOL)hidden
{
    self.subAttri2Identifier = nil;
    [self.subAttri2IconImage setHidden:hidden];
    [self.subAttri2ValueLabel setHidden:hidden];
    [self.subAttri2ArrowImage setHidden:hidden];
    [self.subNextAttri2ValueLabel setHidden:hidden];
}

-(void)setHiddenSubAttribute3Controllers:(BOOL)hidden
{
    self.subAttri3Identifier = nil;
    [self.subAttri3IconImage setHidden:hidden];
    [self.subAttri3ValueLabel setHidden:hidden];
    [self.subAttri3ArrowImage setHidden:hidden];
    [self.subNextAttri3ValueLabel setHidden:hidden];
}

-(void)clearItemsWillCost
{
    if ([self isOkToUp])
    {
        if ([self itemsWillCost] != nil && [[self itemsWillCost] count] > 0)
        {
            for (CostItem* costItem in [self itemsWillCost])
            {
                [[[GameObject sharedInstance] bag] changeItemDataWithId:[costItem itemIId] withNum:-[costItem itemNum]];
            }
        }
    }
}
/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/
-(void)setDataInfoInViewControllers:(NSDictionary *)data;
{
    if ([data objectForKey:@"EquipId"])
    {
        [self resetAllItemView];
        [self hidenAllAttriLabel];
        [self clearItemsWillCost];
        
        self.equipForUpgrade = [[GameObject sharedInstance] getEquipWithEId:[data objectForKey:@"EquipId"]];
        NSString* iconName = [GameUtility getImageNameForEquipStrengthenWithStar:[[self.equipForUpgrade equipStar] intValue]];
        [self.equipStarImage setImage:[GameUtility imageNamed:iconName]];
        [self.equipIconImage setImage:[GameUtility imageNamed:[[self equipForUpgrade] getEquipIcon]]];
        
        self.moneyLabel.text = @"0";
        
        for (int i= 0; i<[self.equipForUpgrade.subAttri count]; i++)
        {
            AttributeData* attri = [[[self equipForUpgrade] subAttri] objectAtIndex:i];
            [self showAttribute:attri AtSlot:i+1];
        }
        
        [self setUpgradeItems];
    }
    else
    {
        NSLog(@"你也倒是给我一个装备ID啊！╮(╯▽╰)╭");
    }
}

-(void)showAttribute:(AttributeData*)attri AtSlot:(int)slot
{
    switch (slot)
    {
        case 1:
        {
            [self setHiddenSubAttribute1Controllers:NO];
            [self showAttribute1:attri];
        }
            break;
        case 2:
        {
            [self setHiddenSubAttribute2Controllers:NO];
            [self showAttribute2:attri];
        }
            break;
        case 3:
        {
            [self setHiddenSubAttribute3Controllers:NO];
            [self showAttribute3:attri];
        }
            break;
        default:
            break;
    }
}

-(void)setUpgradeItems
{
    self.isOkToUp           = true;
    self.itemsWillCost      = [[NSMutableArray alloc] init];
    
    // 获取升级物品
    EquipmentDef* equipDef  = [[EquipmentConfig share] getEquipmentDefWithKey:[[self equipForUpgrade] equipTId]];
    SubAttriLvBase* items   = [[SubAttriLvConfig share] getUpgradeItemsWithLevel:[[[self equipForUpgrade] mainAttri] attriLevel] subAttriUpID:[equipDef subAttriUpID]];
    
    self.moneyLabel.text = [NSString stringWithFormat:@"%lu", items.costMoney];
    self.subAttriLevelLabel.text = [NSString stringWithFormat:@"%lu", items.subAttriLv];
    
    if (items.item1id != 0)
    {
        NSArray* views = [self.item1View subviews];
        QQEquipBtnSelected* selectedView = [views objectAtIndex:0];
        [selectedView setItemDataWithTId:[NSNumber numberWithInteger:items.item1id] countNum:items.item1Num];
        [selectedView setHidden:NO];
        self.isOkToUp &= [selectedView isOKForUpgrade];
        
        [self setCostItemArrayWithId:items.item1id withNum:items.item1Num];
    }
    
    if (items.item2id != 0)
    {
        NSArray* views = [self.item2View subviews];
        QQEquipBtnSelected* selectedView = [views objectAtIndex:0];
        [selectedView setItemDataWithTId:[NSNumber numberWithInteger:items.item2id] countNum:items.item2Num];
        [selectedView setHidden:NO];
        self.isOkToUp &= [selectedView isOKForUpgrade];
        
        [self setCostItemArrayWithId:items.item2id withNum:items.item2Num];
    }
    
    if (items.item3id != 0)
    {
        NSArray* views = [self.item3View subviews];
        QQEquipBtnSelected* selectedView = [views objectAtIndex:0];
        [selectedView setItemDataWithTId:[NSNumber numberWithInteger:items.item3id] countNum:items.item3Num];
        [selectedView setHidden:NO];
        self.isOkToUp &= [selectedView isOKForUpgrade];
        
        [self setCostItemArrayWithId:items.item3id withNum:items.item3Num];
    }
    
    if (items.item4id != 0)
    {
        NSArray* views = [self.item3View subviews];
        QQEquipBtnSelected* selectedView = [views objectAtIndex:0];
        [selectedView setItemDataWithTId:[NSNumber numberWithInteger:items.item4id] countNum:items.item4Num];
        [selectedView setHidden:NO];
        self.isOkToUp &= [selectedView isOKForUpgrade];
        
        [self setCostItemArrayWithId:items.item4id withNum:items.item4Num];
    }
}

-(void)setCostItemArrayWithId:(NSInteger)itemId withNum:(NSInteger)itemNum
{
    Item* item = [[[GameObject sharedInstance] bag] getItemWithTId:[NSNumber numberWithInteger:itemId]];
    CostItem* costItem = [[CostItem alloc] init];
    costItem.itemIId = item.itemIId;
    costItem.itemNum = itemNum;
    [[self itemsWillCost] addObject:costItem];
}

-(void)showAttribute1:(AttributeData*)attr
{
    self.subAttri1Identifier = attr.attriId;
    [self.subAttri1IconImage setImage:[GameUtility imageNamed:[attr getAttriIcon]]];
    self.subAttri1ValueLabel.text = [attr.attriValue stringValue];
    self.subNextAttri1ValueLabel.text = self.subAttri1ValueLabel.text;
}
-(void)showAttribute2:(AttributeData*)attr
{
    self.subAttri2Identifier = attr.attriId;
    [self.subAttri2IconImage setImage:[GameUtility imageNamed:[attr getAttriIcon]]];
    self.subAttri2ValueLabel.text = [attr.attriValue stringValue];
    self.subNextAttri2ValueLabel.text = self.subAttri2ValueLabel.text;
}
-(void)showAttribute3:(AttributeData*)attr
{
    self.subAttri3Identifier = attr.attriId;
    [self.subAttri3IconImage setImage:[GameUtility imageNamed:[attr getAttriIcon]]];
    self.subAttri3ValueLabel.text = [attr.attriValue stringValue];
    self.subNextAttri3ValueLabel.text = self.subAttri3ValueLabel.text;
}

#pragma mark - button events
- (IBAction)onCloseClicked:(id)sender
{
    [[GameUI sharedInstance] showEquipInfoView:nil];
}

- (IBAction)onUpgradeSubClicked:(id)sender
{
    if (self.isOkToUp)
    {
        NSMutableDictionary *tempDict = [[NSMutableDictionary alloc]init];
        [tempDict setObject:[[self equipForUpgrade] equipEId] forKey:@"EID"];
        [[PackageManager sharedInstance] upgradeEquipSubAttriRequest:tempDict];
    }
    else
    {
        [[GameUI sharedInstance] showError:@"需要的物品不够" title:@"临时错误提示"];
    }
}

#pragma mark - notification
-(void)updateEquipInfo:(NSNumber*)equipId
{
    NSDictionary* tempDict = nil;
    if ([equipId isEqualToNumber:[[self equipForUpgrade] equipEId]])
    {
        tempDict = [[NSDictionary alloc] initWithObjectsAndKeys:equipId,@"EquipId", nil];
        [self setDataInfoInViewControllers:tempDict];
    }
}
@end

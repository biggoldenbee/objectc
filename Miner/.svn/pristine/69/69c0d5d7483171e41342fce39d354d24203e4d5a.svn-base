//
//  SkillConfig.m
//  Miner
//
//  Created by zhihua.qian on 14-11-13.
//  Copyright (c) 2014年 jim kaden. All rights reserved.
//

#import "SkillConfig.h"
#import <UIKit/UIKit.h>

@implementation BuffFromSkill

@end

@implementation SkillDef

@end


@implementation SkillConfig
static SkillConfig * _skillConfig = nil;

+(SkillConfig *)share
{
    if (_skillConfig == nil)
    {
        _skillConfig = [[SkillConfig alloc]init];
    }
    return _skillConfig;
}

-(void)dealloc
{
    Definitions = nil;
}

-(void)reset
{
    [super reset];
    Definitions = nil;
}
//
// 重载了父类的方法
//
-(void)initWithString:(NSString *)buffer
{
    NSMutableArray *rows = (NSMutableArray *)[buffer componentsSeparatedByString:@"\r\n"];
    for (int k=1; k<[rows count]-1; k++)
    {
        NSMutableArray *cols = (NSMutableArray *)[[rows objectAtIndex:k] componentsSeparatedByString:@"\t"];
        SkillDef *def = [[SkillDef alloc]init];
        
        int i=0;
        def.skillId     = [[cols objectAtIndex:i++] integerValue];
        def.skillName   = [cols objectAtIndex:i++];
        def.skillDesc   = [cols objectAtIndex:i++];
        def.skillIcon   = [cols objectAtIndex:i++];
        def.needHeroLV  = [[cols objectAtIndex:i++] integerValue];
        def.skillCastVal  = [[cols objectAtIndex:i++] integerValue];
        def.skillTarget = [[cols objectAtIndex:i++] integerValue];
        def.atkType     = [[cols objectAtIndex:i++] integerValue];
        def.attriID     = [[cols objectAtIndex:i++] integerValue];
        def.skillNum    = [[cols objectAtIndex:i++] integerValue];
        def.skillCD     = [[cols objectAtIndex:i++] integerValue];
        NSMutableDictionary *tempDic = [[NSMutableDictionary alloc]init];
        for(int j = 0 ; j < 3 ; j ++ )
        {
            BuffFromSkill *bfs = [[BuffFromSkill alloc]init];
            bfs.buffID       = [[cols objectAtIndex:i++] integerValue];
            if (bfs.buffID != 0)
            {
                bfs.buffChance   = [[cols objectAtIndex:i++] integerValue];
                bfs.buffTarget   = [[cols objectAtIndex:i++] integerValue];
                [tempDic setObject:bfs forKey:[NSString stringWithFormat:@"%lu", bfs.buffID]];
            }
            else
                i+=2 ;
        }
        def.buffDatas = [[NSDictionary alloc]initWithDictionary:tempDic];
        def.attackingAnimation     = [cols objectAtIndex:i++];
        def.attackingEffectAnimation     = [cols objectAtIndex:i++];
        def.defendingAnimation     = [cols objectAtIndex:i++];
        def.defendingEffectAnimation     = [cols objectAtIndex:i++];
        
        def.logFontSize = [[cols objectAtIndex:i++] integerValue];
        
        int r,g,b;
        r = [[cols objectAtIndex:i++] intValue];
        g = [[cols objectAtIndex:i++] intValue];
        b = [[cols objectAtIndex:i++] intValue];
        def.logFontColor = [UIColor colorWithRed:r/255.0f green:g/255.0f blue:b/255.0f alpha:1.0f];
        
        def.animaFontSize = [[cols objectAtIndex:i++] integerValue];
        
        r = [[cols objectAtIndex:i++] intValue];
        g = [[cols objectAtIndex:i++] intValue];
        b = [[cols objectAtIndex:i++] intValue];
        
        def.animaFontColor = [UIColor colorWithRed:r/255.0f green:g/255.0f blue:b/255.0f alpha:1.0f];
        
        if ( [def.attackingAnimation isEqualToString:@"0"] )
            def.attackingAnimation = nil;
        if ( [def.attackingEffectAnimation isEqualToString:@"0"] )
            def.attackingEffectAnimation = nil;
        if ( [def.defendingAnimation isEqualToString:@"0"] )
            def.defendingAnimation = nil;
        if ( [def.defendingEffectAnimation isEqualToString:@"0"] )
            def.defendingEffectAnimation = nil;
        
        [self addRow:def];
    }
}

//
// 重载了父类的方法
//
-(void)loadDBFromLocal
{
    Definitions = [[NSMutableDictionary alloc]init];
    for (int i=0; i<[self numOfRow]; i++)
    {
        SkillDef *def = [self rowAtIndex:i];
        //[Definitions setObject:def forKey:[NSString stringWithFormat:@"%lu", def.skillId]];
        // modified by jim
        // 2015-01-05
        [Definitions setObject:def forKey:[NSNumber numberWithInt:(int)def.skillId]];
        def =nil;
    }
}

-(NSArray*)getAllHeroSkillDefs
{
    NSMutableArray* tempArr = [[NSMutableArray alloc] init];
    for (SkillDef* skill in _DB)
    {
        if ([skill needHeroLV] != 0)
        {
            [tempArr addObject:skill];
        }
    }
    
    return tempArr;
}

-(SkillDef *)getSkillDefWithIdentifier:(NSNumber*)identifier
{
    SkillDef *skill = [Definitions objectForKey:identifier];
    return skill;
}
@end
